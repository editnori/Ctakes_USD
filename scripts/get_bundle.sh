#!/usr/bin/env bash\nset -euo pipefail\n\nRELEASE_TAG="${1:-bundle}"\nASSET_NAME="CtakesBun-bundle.tgz"\nBASE_DIR="$(cd "$(dirname "$0")/.." && pwd)"\nEXPECTED_DIR="${BASE_DIR}/CtakesBun-bundle"\nEXPECTED_CTAKES="${EXPECTED_DIR}/apache-ctakes-6.0.0-bin/apache-ctakes-6.0.0"\n\nif [[ -d "${EXPECTED_CTAKES}" ]]; then\n  echo "[get_bundle] Found existing bundle at ${EXPECTED_CTAKES}"\n  exit 0\nfi\n\nDOWNLOAD_URL="https://github.com/editnori/Ctakes_USD/releases/download/${RELEASE_TAG}/${ASSET_NAME}"\nCHECKSUM_URL="${DOWNLOAD_URL}.sha256"\nTMP_FILE="${TMPDIR:-/tmp}/${ASSET_NAME}.download"\nTMP_SUM="${TMP_FILE}.sha256"\nTMP_DIR="${TMPDIR:-/tmp}/ctakes_bundle.$$"\n\nmkdir -p "${TMP_DIR}"\ntrap 'rm -rf "${TMP_DIR}" "${TMP_FILE}" "${TMP_SUM}"' EXIT\n\necho "[get_bundle] Downloading ${ASSET_NAME} from ${DOWNLOAD_URL}"\ncurl -L --fail --progress-bar -o "${TMP_FILE}" "${DOWNLOAD_URL}"\n\nif curl -L --fail --silent --show-error -o "${TMP_SUM}" "${CHECKSUM_URL}"; then\n  PYTHON_BIN=$(command -v python3 || command -v python || true)\n  if [[ -z "${PYTHON_BIN}" ]]; then\n    echo "[get_bundle] Warning: python not available; skipping checksum verification" >&2\n  else\n    EXPECTED_SUM=$(head -n 1 "${TMP_SUM}" | awk '{print $1}')\n    if [[ -z "${EXPECTED_SUM}" ]]; then\n      echo "[get_bundle] Warning: checksum file ${CHECKSUM_URL} is empty; skipping verification" >&2\n    else\n      echo "[get_bundle] Verifying SHA-256 checksum"\n      ACTUAL_SUM=$("${PYTHON_BIN}" - <<'PY' "${TMP_FILE}"\nimport hashlib\nimport sys\npath = sys.argv[1]\nh = hashlib.sha256()\nwith open(path, 'rb') as stream:\n    for chunk in iter(lambda: stream.read(1024 * 1024), b''):\n        h.update(chunk)\nprint(h.hexdigest())\nPY\n)\n      if [[ "${ACTUAL_SUM,,}" != "${EXPECTED_SUM,,}" ]]; then\n        echo "[get_bundle] Checksum mismatch for ${ASSET_NAME}" >&2\n        exit 1\n      fi\n      echo "[get_bundle] Checksum verified"\n    fi\n  fi\nelse\n  echo "[get_bundle] Warning: checksum file not found at ${CHECKSUM_URL}; skipping verification" >&2\nfi\n\necho "[get_bundle] Extracting into temporary directory"\ntar -xzf "${TMP_FILE}" -C "${TMP_DIR}"\n\nif [[ -d "${TMP_DIR}/Ctakes_USD_clean/CtakesBun-bundle" ]]; then\n  mv "${TMP_DIR}/Ctakes_USD_clean/CtakesBun-bundle" "${TMP_DIR}/CtakesBun-bundle"\nfi\n\nif [[ -d "${TMP_DIR}/CtakesBun-bundle" ]]; then\n  rm -rf "${EXPECTED_DIR}"\n  mv "${TMP_DIR}/CtakesBun-bundle" "${EXPECTED_DIR}"\nelse\n  echo "[get_bundle] Unexpected bundle layout. Expected CtakesBun-bundle in archive." >&2\n  exit 1\nfi\n\nif [[ ! -d "${EXPECTED_CTAKES}" ]]; then\n  echo "[get_bundle] Extraction completed but ${EXPECTED_CTAKES} not found" >&2\n  exit 1\nfi\n\nDICT_DIR="${EXPECTED_CTAKES}/resources/org/apache/ctakes/dictionary/lookup/fast"\nLOCAL_DICT="${DICT_DIR}/KidneyStone_SDOH_local.xml"\nDEFAULT_DICT="${DICT_DIR}/KidneyStone_SDOH.xml"\nif [[ -f "${LOCAL_DICT}" && -f "${DEFAULT_DICT}" ]]; then\n  echo "[get_bundle] Bundle ready at ${EXPECTED_CTAKES}"\nelse\n  echo "[get_bundle] Warning: KidneyStone_SDOH dictionary not found under ${DICT_DIR}" >&2\nfi\n
